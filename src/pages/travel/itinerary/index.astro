---
import MainLayout from '../../../layouts/MainLayout.astro';

const user = Astro.locals.user;
if (!user) {
  return Astro.redirect('/login');
}

const title = 'Travel Itinerary (IoT)';
---

<MainLayout title={title}>
  <div class="container mx-auto px-4 py-6">
    <!-- Header -->
    <div class="flex justify-between items-center mb-6">
      <div>
        <h1 class="text-3xl font-bold text-gray-900">Travel Itinerary</h1>
        <p class="text-gray-600 mt-1">Manage itinerary of travel requests</p>
      </div>
      <a
        href="/travel/itinerary/create"
        class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md font-medium transition-colors inline-flex items-center gap-2"
      >
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
        </svg>
        Create New IoT
      </a>
    </div>

    <!-- Filters -->
    <div class="bg-white rounded-lg shadow p-4 mb-6">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
          <select id="filterStatus" class="w-full px-3 py-2 border border-gray-300 rounded-md">
            <option value="">All Statuses</option>
            <option value="draft">Draft</option>
            <option value="pending_approval">Pending Approval</option>
            <option value="approved">Approved</option>
            <option value="in_progress">In Progress</option>
            <option value="completed">Completed</option>
            <option value="cancelled">Cancelled</option>
          </select>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">From Date</label>
          <input type="date" id="filterFromDate" class="w-full px-3 py-2 border border-gray-300 rounded-md" />
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">To Date</label>
          <input type="date" id="filterToDate" class="w-full px-3 py-2 border border-gray-300 rounded-md" />
        </div>

        <div class="flex items-end">
          <button
            id="btnApplyFilter"
            class="w-full bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-md font-medium transition-colors"
          >
            Apply Filters
          </button>
        </div>
      </div>
    </div>

    <!-- IoT List -->
    <div class="bg-white rounded-lg shadow">
      <div id="loadingIndicator" class="p-8 text-center">
        <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
        <p class="mt-2 text-gray-600">Loading travel records...</p>
      </div>

      <div id="iotListContainer" class="hidden">
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">IoT No.</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Employee</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Destination</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Travel Period</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estimated Cost</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
              </tr>
            </thead>
            <tbody id="iotTableBody" class="bg-white divide-y divide-gray-200">
              <!-- Rows will be inserted here by JavaScript -->
            </tbody>
          </table>
        </div>

        <div id="emptyState" class="hidden p-8 text-center">
          <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
          </svg>
          <p class="mt-4 text-gray-600">No travel records found</p>
          <a href="/travel/itinerary/create" class="mt-4 inline-block text-blue-600 hover:text-blue-700">
            Create your first IoT
          </a>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Fetch and display IoTs
    async function loadIoTs(filters = {}) {
      const loadingIndicator = document.getElementById('loadingIndicator');
      const iotListContainer = document.getElementById('iotListContainer');
      const iotTableBody = document.getElementById('iotTableBody');
      const emptyState = document.getElementById('emptyState');

      if (loadingIndicator) loadingIndicator.classList.remove('hidden');
      if (iotListContainer) iotListContainer.classList.add('hidden');

      try {
        const params = new URLSearchParams();
        if (filters.status) params.append('status', filters.status);
        if (filters.fromDate) params.append('fromDate', filters.fromDate);
        if (filters.toDate) params.append('toDate', filters.toDate);

        const response = await fetch(`/api/travel?${params.toString()}`);
        const data = await response.json();

        if (loadingIndicator) loadingIndicator.classList.add('hidden');
        if (iotListContainer) iotListContainer.classList.remove('hidden');

        if (!data.iots || data.iots.length === 0) {
          if (iotTableBody) iotTableBody.innerHTML = '';
          if (emptyState) emptyState.classList.remove('hidden');
          return;
        }

        if (emptyState) emptyState.classList.add('hidden');

        if (iotTableBody) {
          iotTableBody.innerHTML = data.iots.map(item => {
            const iot = item.iot;
            const employee = item.employee;
            const statusBadge = getStatusBadge(iot.status);

            return `
              <tr class="hover:bg-gray-50">
                <td class="px-6 py-4 whitespace-nowrap">
                  <a href="/travel/itinerary/${iot.id}" class="text-blue-600 hover:text-blue-800 font-medium">
                    ${iot.iotNo}
                  </a>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <div class="text-sm font-medium text-gray-900">${employee?.firstName} ${employee?.lastName}</div>
                  <div class="text-sm text-gray-500">${employee?.employeeNo}</div>
                </td>
                <td class="px-6 py-4">
                  <div class="text-sm text-gray-900">${iot.destination}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <div class="text-sm text-gray-900">${formatDate(iot.departureDate)}</div>
                  <div class="text-sm text-gray-500">to ${formatDate(iot.returnDate)}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <div class="text-sm font-medium text-gray-900">${formatCurrency(iot.estimatedCost)}</div>
                  ${iot.cashAdvanceAmount ? `<div class="text-xs text-gray-500">CA: ${formatCurrency(iot.cashAdvanceAmount)}</div>` : ''}
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  ${statusBadge}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm">
                  <a href="/travel/itinerary/${iot.id}" class="text-blue-600 hover:text-blue-800">View</a>
                </td>
              </tr>
            `;
          }).join('');
        }
      } catch (error) {
        console.error('Error loading IoTs:', error);
        if (loadingIndicator) loadingIndicator.classList.add('hidden');
        if (iotListContainer) iotListContainer.classList.remove('hidden');
        if (iotTableBody) {
          iotTableBody.innerHTML = `
            <tr>
              <td colspan="7" class="px-6 py-4 text-center text-red-600">
                Error loading travel records. Please try again.
              </td>
            </tr>
          `;
        }
      }
    }

    function getStatusBadge(status) {
      const badges = {
        'draft': '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-800">Draft</span>',
        'pending_approval': '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800">Pending Approval</span>',
        'approved': '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">Approved</span>',
        'in_progress': '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800">In Progress</span>',
        'completed': '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-purple-100 text-purple-800">Completed</span>',
        'cancelled': '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800">Cancelled</span>',
      };
      return badges[status] || status;
    }

    function formatDate(dateString) {
      if (!dateString) return '';
      const date = new Date(dateString);
      return date.toLocaleDateString('en-PH', { year: 'numeric', month: 'short', day: 'numeric' });
    }

    function formatCurrency(value) {
      if (!value) return 'â‚±0.00';
      return new Intl.NumberFormat('en-PH', { style: 'currency', currency: 'PHP' }).format(value);
    }

    // Apply filters
    document.getElementById('btnApplyFilter')?.addEventListener('click', () => {
      const status = (document.getElementById('filterStatus') as HTMLSelectElement)?.value;
      const fromDate = (document.getElementById('filterFromDate') as HTMLInputElement)?.value;
      const toDate = (document.getElementById('filterToDate') as HTMLInputElement)?.value;

      loadIoTs({ status, fromDate, toDate });
    });

    // Load IoTs on page load
    document.addEventListener('DOMContentLoaded', () => {
      loadIoTs();
    });
  </script>
</MainLayout>
