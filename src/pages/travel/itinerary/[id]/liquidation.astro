---
import MainLayout from '../../../../layouts/MainLayout.astro';
import LiquidationReportForm from '../../../../components/forms/travel/LiquidationReportForm.vue';
import { TravelService } from '../../../../lib/services/travel.service';

const user = Astro.locals.user;
if (!user) {
  return Astro.redirect('/login');
}

const { id } = Astro.params;
if (!id) {
  return Astro.redirect('/travel/itinerary');
}

// Fetch IoT data
const iot = await TravelService.getIoTById(parseInt(id));

if (!iot) {
  return Astro.redirect('/travel/itinerary');
}

// Check if liquidation already exists
const existingLiquidation = await TravelService.getLiquidationByIoTId(parseInt(id));
if (existingLiquidation) {
  return Astro.redirect(`/travel/itinerary/${id}`);
}

// Validate IoT status (must be completed)
if (iot.iot.status !== 'completed') {
  return Astro.redirect(`/travel/itinerary/${id}`);
}

// Fetch CTC data
const ctc = await TravelService.getCTCByIoTId(parseInt(id));
if (!ctc) {
  return Astro.redirect(`/travel/itinerary/${id}`);
}

const title = `Create Liquidation Report - ${iot.iot.iotNo}`;
---

<MainLayout title={title}>
  <div class="container mx-auto px-4 py-6 max-w-5xl">
    <!-- Header -->
    <div class="mb-6">
      <a href={`/travel/itinerary/${id}`} class="text-blue-600 hover:text-blue-700 inline-flex items-center gap-1 mb-2">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
        </svg>
        Back to IoT Details
      </a>
      <h1 class="text-3xl font-bold text-gray-900">Create Liquidation Report</h1>
      <p class="text-gray-600 mt-1">IoT No: {iot.iot.iotNo}</p>
    </div>

    <!-- Travel Summary Card -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
      <h2 class="text-lg font-semibold text-gray-900 mb-4">Travel Summary</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
          <p class="text-sm text-gray-600">Employee</p>
          <p class="font-medium">{iot.employee.firstName} {iot.employee.lastName}</p>
        </div>
        <div>
          <p class="text-sm text-gray-600">Destination</p>
          <p class="font-medium">{iot.iot.destination}</p>
        </div>
        <div>
          <p class="text-sm text-gray-600">Travel Period</p>
          <p class="font-medium">
            {new Date(ctc.ctc.actualDepartureDate).toLocaleDateString('en-PH', { month: 'short', day: 'numeric' })} -
            {new Date(ctc.ctc.actualReturnDate).toLocaleDateString('en-PH', { month: 'short', day: 'numeric', year: 'numeric' })}
          </p>
        </div>
        <div>
          <p class="text-sm text-gray-600">Cash Advance</p>
          <p class="font-medium text-lg">
            {new Intl.NumberFormat('en-PH', { style: 'currency', currency: 'PHP' }).format(parseFloat(iot.iot.cashAdvanceAmount || '0'))}
          </p>
        </div>
        <div>
          <p class="text-sm text-gray-600">Fund Cluster</p>
          <p class="font-medium">{iot.fundCluster.name}</p>
        </div>
        {iot.iot.dvId && (
          <div>
            <p class="text-sm text-gray-600">Cash Advance DV</p>
            <a href={`/disbursements/${iot.iot.dvId}`} class="text-blue-600 hover:text-blue-700 font-medium">
              View DV
            </a>
          </div>
        )}
      </div>
    </div>

    <!-- Form -->
    <div id="formContainer">
      <LiquidationReportForm
        client:load
        :iotData={JSON.stringify({
          id: iot.iot.id,
          iotNo: iot.iot.iotNo,
          ctcId: ctc.ctc.id,
          fundClusterId: iot.iot.fundClusterId,
          cashAdvanceAmount: parseFloat(iot.iot.cashAdvanceAmount || '0'),
          cashAdvanceDvId: iot.iot.dvId
        })}
      />
    </div>
  </div>

  <script define:vars={{ iotId: parseInt(id) }}>
    document.addEventListener('DOMContentLoaded', () => {
      const formContainer = document.getElementById('formContainer');
      if (!formContainer) return;

      // Listen for submit event from Vue component
      formContainer.addEventListener('submit', async (event) => {
        const customEvent = event;
        const formData = customEvent.detail;

        try {
          const response = await fetch(`/api/travel/${iotId}/liquidation`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData),
          });

          const data = await response.json();

          if (response.ok) {
            // Show detailed success message with refund/additional claim
            let message = `Liquidation Report created successfully!\nLR No: ${data.lrNo}\n\n`;
            message += `Total Expenses: ${new Intl.NumberFormat('en-PH', { style: 'currency', currency: 'PHP' }).format(data.totalExpenses)}\n`;
            message += `Cash Advance: ${new Intl.NumberFormat('en-PH', { style: 'currency', currency: 'PHP' }).format(data.cashAdvanceAmount)}\n\n`;

            if (data.refundAmount > 0) {
              message += `Refund to Agency: ${new Intl.NumberFormat('en-PH', { style: 'currency', currency: 'PHP' }).format(data.refundAmount)}`;
            } else if (data.additionalClaim > 0) {
              message += `Additional Claim: ${new Intl.NumberFormat('en-PH', { style: 'currency', currency: 'PHP' }).format(data.additionalClaim)}`;
            } else {
              message += `Balanced - No refund or additional claim needed.`;
            }

            alert(message);

            // Redirect to the IoT detail page
            window.location.href = `/travel/itinerary/${iotId}`;
          } else {
            alert(`Error: ${data.error || 'Failed to create liquidation report'}`);
          }
        } catch (error) {
          console.error('Error creating liquidation:', error);
          alert('An error occurred while creating the liquidation report');
        }
      });

      // Listen for cancel event
      formContainer.addEventListener('cancel', () => {
        window.location.href = `/travel/itinerary/${iotId}`;
      });
    });
  </script>
</MainLayout>
