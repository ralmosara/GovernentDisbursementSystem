---
import MainLayout from '../../../layouts/MainLayout.astro';
import UserManagement from '../../../components/admin/UserManagement.vue';
import { db } from '../../../lib/db/connection';
import { userRoles, roles } from '../../../lib/db/schema';
import { eq } from 'drizzle-orm';

const user = Astro.locals.user;
if (!user) {
  return Astro.redirect('/login');
}

// Get user's roles
const userRoleRecords = await db
  .select({
    role: roles,
  })
  .from(userRoles)
  .leftJoin(roles, eq(userRoles.roleId, roles.id))
  .where(eq(userRoles.userId, user.id));

const userRoleNames = userRoleRecords.map(r => r.role?.name || '');

// Only administrators can manage users
const isAdmin = userRoleNames.includes('administrator');

if (!isAdmin) {
  return Astro.redirect('/dashboard');
}
---

<MainLayout title="User Management" user={user}>
  <div class="page-header">
    <h1>User Management</h1>
    <p>Manage system users, roles, and permissions</p>
  </div>

  <UserManagement client:load />
</MainLayout>

<style>
  .page-header {
    margin-bottom: 2rem;
  }

  .page-header h1 {
    font-size: 2rem;
    font-weight: 700;
    color: #1f2937;
    margin-bottom: 0.5rem;
  }

  .page-header p {
    color: #6b7280;
    font-size: 1rem;
  }
</style>
