---
import MainLayout from '../../../layouts/MainLayout.astro';
import { db } from '../../../lib/db/connection';
import { fundClusters } from '../../../lib/db/schema';

const user = Astro.locals.user;

if (!user) {
  return Astro.redirect('/login');
}

// Get all fund clusters for dropdown
const allFundClusters = await db.select().from(fundClusters);

const currentYear = new Date().getFullYear();
const fiscalYears = Array.from({ length: 5 }, (_, i) => currentYear - i);
---

<MainLayout title="BAR No. 1 - Budget Utilization Report">
  <div class="container-fluid py-6">
    <!-- Page Header -->
    <div class="page-header">
      <div>
        <h1 class="page-title">BAR No. 1</h1>
        <p class="page-description">Budget Accountability Report - Budget Utilization</p>
      </div>
      <div>
        <a href="/reports" class="btn btn-ghost">
          <i class="pi pi-arrow-left mr-2"></i>
          Back to Reports
        </a>
      </div>
    </div>

    <!-- Report Parameters -->
    <div class="card mb-6">
      <div class="card-header">
        <h3 class="text-lg font-semibold">Report Parameters</h3>
      </div>
      <div class="card-body">
        <form id="report-form" class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <!-- Fiscal Year -->
          <div class="form-control">
            <label class="label">
              <span class="label-text">Fiscal Year *</span>
            </label>
            <select
              name="fiscalYear"
              id="fiscal-year"
              class="select select-bordered w-full"
              required
            >
              {fiscalYears.map(year => (
                <option value={year} selected={year === currentYear}>
                  {year}
                </option>
              ))}
            </select>
          </div>

          <!-- Fund Cluster -->
          <div class="form-control">
            <label class="label">
              <span class="label-text">Fund Cluster</span>
            </label>
            <select
              name="fundClusterId"
              id="fund-cluster"
              class="select select-bordered w-full"
            >
              <option value="">All Fund Clusters</option>
              {allFundClusters.map(fc => (
                <option value={fc.id}>{fc.code} - {fc.name}</option>
              ))}
            </select>
          </div>

          <!-- Format -->
          <div class="form-control">
            <label class="label">
              <span class="label-text">Export Format *</span>
            </label>
            <select
              name="format"
              id="format"
              class="select select-bordered w-full"
              required
            >
              <option value="excel">Excel (.xlsx)</option>
              <option value="json">JSON (Preview)</option>
            </select>
          </div>

          <!-- Action Buttons -->
          <div class="md:col-span-3 flex gap-2">
            <button type="button" id="preview-btn" class="btn btn-ghost">
              <i class="pi pi-eye mr-2"></i>
              Preview Report
            </button>
            <button type="button" id="download-btn" class="btn btn-primary">
              <i class="pi pi-download mr-2"></i>
              Download Excel
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Report Preview -->
    <div id="report-preview" class="hidden">
      <div class="card">
        <div class="card-header">
          <h3 class="text-lg font-semibold" id="preview-title">Report Preview</h3>
        </div>
        <div class="card-body p-0">
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200" id="preview-table">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Object Code</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Object of Expenditure</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Category</th>
                  <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Appropriation</th>
                  <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Allotment</th>
                  <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Obligations</th>
                  <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Disbursements</th>
                  <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Unobligated</th>
                  <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Available</th>
                  <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Utilization %</th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-200" id="preview-tbody">
                <!-- Data will be inserted here -->
              </tbody>
              <tfoot class="bg-gray-100 font-bold" id="preview-tfoot">
                <!-- Totals will be inserted here -->
              </tfoot>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Loading Indicator -->
    <div id="loading" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div class="bg-white rounded-lg p-6 flex items-center gap-4">
        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary-600"></div>
        <span class="text-lg font-semibold">Generating report...</span>
      </div>
    </div>
  </div>

  <script>
    const form = document.getElementById('report-form') as HTMLFormElement;
    const previewBtn = document.getElementById('preview-btn') as HTMLButtonElement;
    const downloadBtn = document.getElementById('download-btn') as HTMLButtonElement;
    const loading = document.getElementById('loading')!;
    const reportPreview = document.getElementById('report-preview')!;
    const previewTitle = document.getElementById('preview-title')!;
    const previewTbody = document.getElementById('preview-tbody')!;
    const previewTfoot = document.getElementById('preview-tfoot')!;

    function getReportParams() {
      const formData = new FormData(form);
      const params = new URLSearchParams();
      params.set('fiscalYear', formData.get('fiscalYear') as string);
      if (formData.get('fundClusterId')) {
        params.set('fundClusterId', formData.get('fundClusterId') as string);
      }
      return params;
    }

    // Preview Report
    previewBtn.addEventListener('click', async () => {
      try {
        loading.classList.remove('hidden');
        reportPreview.classList.add('hidden');

        const params = getReportParams();
        params.set('format', 'json');

        const response = await fetch(`/api/reports/bar?${params}`);

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.message || 'Failed to generate report');
        }

        const data = await response.json();

        // Update preview title
        previewTitle.textContent = `BAR No. 1 - Fiscal Year ${data.fiscalYear}${
          data.fundCluster ? ` - Fund Cluster ${data.fundCluster.code}` : ' - All Fund Clusters'
        }`;

        // Populate table
        previewTbody.innerHTML = data.items.map((item: any) => `
          <tr class="hover:bg-gray-50">
            <td class="px-4 py-3 text-sm text-gray-900">${item.objectCode}</td>
            <td class="px-4 py-3 text-sm text-gray-900">${item.objectName}</td>
            <td class="px-4 py-3 text-sm text-gray-600">${item.category}</td>
            <td class="px-4 py-3 text-sm text-gray-900 text-right">₱${item.appropriation.toLocaleString('en-PH', { minimumFractionDigits: 2 })}</td>
            <td class="px-4 py-3 text-sm text-gray-900 text-right">₱${item.allotment.toLocaleString('en-PH', { minimumFractionDigits: 2 })}</td>
            <td class="px-4 py-3 text-sm text-gray-900 text-right">₱${item.obligations.toLocaleString('en-PH', { minimumFractionDigits: 2 })}</td>
            <td class="px-4 py-3 text-sm text-gray-900 text-right">₱${item.disbursements.toLocaleString('en-PH', { minimumFractionDigits: 2 })}</td>
            <td class="px-4 py-3 text-sm text-gray-900 text-right">₱${item.unobligated.toLocaleString('en-PH', { minimumFractionDigits: 2 })}</td>
            <td class="px-4 py-3 text-sm text-gray-900 text-right">₱${item.available.toLocaleString('en-PH', { minimumFractionDigits: 2 })}</td>
            <td class="px-4 py-3 text-sm text-gray-900 text-center">${item.utilizationRate.toFixed(2)}%</td>
          </tr>
        `).join('');

        // Populate totals
        previewTfoot.innerHTML = `
          <tr>
            <td colspan="3" class="px-4 py-3 text-sm text-gray-900 font-bold">TOTAL</td>
            <td class="px-4 py-3 text-sm text-gray-900 text-right font-bold">₱${data.totals.appropriation.toLocaleString('en-PH', { minimumFractionDigits: 2 })}</td>
            <td class="px-4 py-3 text-sm text-gray-900 text-right font-bold">₱${data.totals.allotment.toLocaleString('en-PH', { minimumFractionDigits: 2 })}</td>
            <td class="px-4 py-3 text-sm text-gray-900 text-right font-bold">₱${data.totals.obligations.toLocaleString('en-PH', { minimumFractionDigits: 2 })}</td>
            <td class="px-4 py-3 text-sm text-gray-900 text-right font-bold">₱${data.totals.disbursements.toLocaleString('en-PH', { minimumFractionDigits: 2 })}</td>
            <td class="px-4 py-3 text-sm text-gray-900 text-right font-bold">₱${data.totals.unobligated.toLocaleString('en-PH', { minimumFractionDigits: 2 })}</td>
            <td class="px-4 py-3 text-sm text-gray-900 text-right font-bold">₱${data.totals.available.toLocaleString('en-PH', { minimumFractionDigits: 2 })}</td>
            <td class="px-4 py-3 text-sm text-gray-900 text-center font-bold">${data.totals.utilizationRate.toFixed(2)}%</td>
          </tr>
        `;

        reportPreview.classList.remove('hidden');
      } catch (error) {
        console.error('Error generating preview:', error);
        alert('Failed to generate report preview: ' + (error as Error).message);
      } finally {
        loading.classList.add('hidden');
      }
    });

    // Download Excel
    downloadBtn.addEventListener('click', async () => {
      try {
        loading.classList.remove('hidden');

        const params = getReportParams();
        params.set('format', 'excel');

        const response = await fetch(`/api/reports/bar?${params}`);

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.message || 'Failed to generate report');
        }

        // Download file
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `BAR_No1_FY${params.get('fiscalYear')}_${new Date().toISOString().split('T')[0]}.xlsx`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);

        alert('Report downloaded successfully!');
      } catch (error) {
        console.error('Error downloading report:', error);
        alert('Failed to download report: ' + (error as Error).message);
      } finally {
        loading.classList.add('hidden');
      }
    });

    // Auto-preview on load if fiscal year is in URL
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('fiscalYear')) {
      (document.getElementById('fiscal-year') as HTMLSelectElement).value = urlParams.get('fiscalYear')!;
      previewBtn.click();
    }
  </script>
</MainLayout>
