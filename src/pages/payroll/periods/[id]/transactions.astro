---
import MainLayout from '../../../../layouts/MainLayout.astro';
import { payrollService } from '../../../../lib/services/payroll.service';

const user = Astro.locals.user;

if (!user) {
  return Astro.redirect('/login');
}

const periodId = parseInt(Astro.params.id || '0');

// Fetch period details
const period = await payrollService.getPayrollPeriodById(periodId);

if (!period) {
  return Astro.redirect('/payroll/periods');
}

// Fetch transactions
const transactions = await payrollService.getPayrollTransactions(periodId);

// Format currency
function formatCurrency(amount: number | string | null): string {
  if (!amount) return '₱0.00';
  const num = typeof amount === 'string' ? parseFloat(amount) : amount;
  return '₱' + num.toLocaleString('en-PH', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

// Calculate totals
const totalGrossPay = transactions.reduce((sum, t) => sum + parseFloat(t.grossPay || 0), 0);
const totalGSIS = transactions.reduce((sum, t) => sum + parseFloat(t.gsisContribution || 0), 0);
const totalPhilHealth = transactions.reduce((sum, t) => sum + parseFloat(t.philhealthContribution || 0), 0);
const totalPagIbig = transactions.reduce((sum, t) => sum + parseFloat(t.pagibigContribution || 0), 0);
const totalWithholdingTax = transactions.reduce((sum, t) => sum + parseFloat(t.withholdingTax || 0), 0);
const totalLoans = transactions.reduce((sum, t) => {
  const gsisLoan = parseFloat(t.gsisLoan || 0);
  const pagibigLoan = parseFloat(t.pagibigLoan || 0);
  const salaryLoan = parseFloat(t.salaryLoan || 0);
  return sum + gsisLoan + pagibigLoan + salaryLoan;
}, 0);
const totalDeductions = transactions.reduce((sum, t) => sum + parseFloat(t.totalDeductions || 0), 0);
const totalNetPay = transactions.reduce((sum, t) => sum + parseFloat(t.netPay || 0), 0);
---

<MainLayout title={`Payroll Transactions - ${period.periodNo}`}>
  <div class="container-fluid py-6">
    <!-- Breadcrumb -->
    <nav class="flex mb-4" aria-label="Breadcrumb">
      <ol class="inline-flex items-center space-x-1 md:space-x-3">
        <li class="inline-flex items-center">
          <a href="/payroll/periods" class="text-gray-700 hover:text-primary-600">
            Payroll Periods
          </a>
        </li>
        <li>
          <div class="flex items-center">
            <i class="pi pi-chevron-right text-gray-400 text-sm"></i>
            <a href={`/payroll/periods/${period.id}`} class="ml-1 text-gray-700 hover:text-primary-600 md:ml-2">
              {period.periodNo}
            </a>
          </div>
        </li>
        <li>
          <div class="flex items-center">
            <i class="pi pi-chevron-right text-gray-400 text-sm"></i>
            <span class="ml-1 text-gray-500 md:ml-2">Transactions</span>
          </div>
        </li>
      </ol>
    </nav>

    <!-- Page Header -->
    <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6">
      <div>
        <h1 class="text-3xl font-bold text-gray-900">Payroll Transactions</h1>
        <p class="mt-1 text-sm text-gray-600">
          {period.periodNo} - {period.periodName || `${period.periodType} Payroll`}
        </p>
      </div>
      <div class="mt-4 md:mt-0 flex gap-3">
        <button
          type="button"
          class="btn btn-secondary"
          onclick="exportToCSV()"
        >
          <i class="pi pi-download mr-2"></i>
          Export CSV
        </button>
        <a href={`/payroll/periods/${period.id}`} class="btn btn-ghost">
          <i class="pi pi-arrow-left mr-2"></i>
          Back to Period
        </a>
      </div>
    </div>

    <!-- Summary Cards -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
      <div class="bg-white rounded-lg shadow border border-gray-200 p-4">
        <p class="text-sm font-medium text-gray-600">Total Employees</p>
        <p class="text-2xl font-bold text-gray-900 mt-1">{transactions.length}</p>
      </div>

      <div class="bg-white rounded-lg shadow border border-gray-200 p-4">
        <p class="text-sm font-medium text-gray-600">Total Gross Pay</p>
        <p class="text-xl font-bold text-gray-900 mt-1">{formatCurrency(totalGrossPay)}</p>
      </div>

      <div class="bg-white rounded-lg shadow border border-gray-200 p-4">
        <p class="text-sm font-medium text-gray-600">Total Deductions</p>
        <p class="text-xl font-bold text-red-600 mt-1">{formatCurrency(totalDeductions)}</p>
      </div>

      <div class="bg-white rounded-lg shadow border border-gray-200 p-4">
        <p class="text-sm font-medium text-gray-600">Total Net Pay</p>
        <p class="text-xl font-bold text-green-600 mt-1">{formatCurrency(totalNetPay)}</p>
      </div>
    </div>

    <!-- Transactions Table -->
    <div class="bg-white rounded-lg shadow border border-gray-200 overflow-hidden">
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200" id="transactions-table">
          <thead class="bg-gray-50">
            <tr>
              <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                Employee No
              </th>
              <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                Employee Name
              </th>
              <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                Position
              </th>
              <th scope="col" class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                Gross Pay
              </th>
              <th scope="col" class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                GSIS
              </th>
              <th scope="col" class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                PhilHealth
              </th>
              <th scope="col" class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                Pag-IBIG
              </th>
              <th scope="col" class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                W/Tax
              </th>
              <th scope="col" class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                Loans
              </th>
              <th scope="col" class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                Total Deductions
              </th>
              <th scope="col" class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                Net Pay
              </th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            {transactions.length === 0 ? (
              <tr>
                <td colspan="11" class="px-6 py-12 text-center">
                  <div class="flex flex-col items-center justify-center">
                    <i class="pi pi-inbox text-gray-300 text-5xl mb-4"></i>
                    <p class="text-gray-500 text-lg">No transactions found</p>
                  </div>
                </td>
              </tr>
            ) : (
              transactions.map((t: any) => {
                const loans = (parseFloat(t.gsisLoan || 0) + parseFloat(t.pagibigLoan || 0) + parseFloat(t.salaryLoan || 0));
                return (
                  <tr class="hover:bg-gray-50 transition-colors">
                    <td class="px-4 py-3 whitespace-nowrap">
                      <div class="text-sm font-medium text-gray-900">
                        {t.employee?.employeeNo}
                      </div>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap">
                      <div class="text-sm text-gray-900">
                        {t.employee?.firstName} {t.employee?.lastName}
                      </div>
                    </td>
                    <td class="px-4 py-3">
                      <div class="text-sm text-gray-900">{t.employee?.position}</div>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap text-right">
                      <div class="text-sm font-medium text-gray-900">
                        {formatCurrency(t.grossPay)}
                      </div>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap text-right">
                      <div class="text-sm text-gray-900">
                        {formatCurrency(t.gsisContribution)}
                      </div>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap text-right">
                      <div class="text-sm text-gray-900">
                        {formatCurrency(t.philhealthContribution)}
                      </div>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap text-right">
                      <div class="text-sm text-gray-900">
                        {formatCurrency(t.pagibigContribution)}
                      </div>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap text-right">
                      <div class="text-sm text-gray-900">
                        {formatCurrency(t.withholdingTax)}
                      </div>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap text-right">
                      <div class="text-sm text-gray-900">
                        {formatCurrency(loans)}
                      </div>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap text-right">
                      <div class="text-sm font-medium text-red-600">
                        {formatCurrency(t.totalDeductions)}
                      </div>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap text-right">
                      <div class="text-sm font-bold text-green-600">
                        {formatCurrency(t.netPay)}
                      </div>
                    </td>
                  </tr>
                );
              })
            )}
          </tbody>
          {transactions.length > 0 && (
            <tfoot class="bg-gray-100 font-bold">
              <tr>
                <td colspan="3" class="px-4 py-3 text-sm text-gray-900 text-right">
                  TOTAL:
                </td>
                <td class="px-4 py-3 text-sm text-gray-900 text-right">
                  {formatCurrency(totalGrossPay)}
                </td>
                <td class="px-4 py-3 text-sm text-gray-900 text-right">
                  {formatCurrency(totalGSIS)}
                </td>
                <td class="px-4 py-3 text-sm text-gray-900 text-right">
                  {formatCurrency(totalPhilHealth)}
                </td>
                <td class="px-4 py-3 text-sm text-gray-900 text-right">
                  {formatCurrency(totalPagIbig)}
                </td>
                <td class="px-4 py-3 text-sm text-gray-900 text-right">
                  {formatCurrency(totalWithholdingTax)}
                </td>
                <td class="px-4 py-3 text-sm text-gray-900 text-right">
                  {formatCurrency(totalLoans)}
                </td>
                <td class="px-4 py-3 text-sm text-red-600 text-right">
                  {formatCurrency(totalDeductions)}
                </td>
                <td class="px-4 py-3 text-sm text-green-600 text-right">
                  {formatCurrency(totalNetPay)}
                </td>
              </tr>
            </tfoot>
          )}
        </table>
      </div>
    </div>

    <!-- Result Count -->
    {transactions.length > 0 && (
      <div class="mt-4 text-sm text-gray-600">
        Showing {transactions.length} transaction{transactions.length !== 1 ? 's' : ''}
      </div>
    )}
  </div>
</MainLayout>

<script>
  function exportToCSV() {
    const table = document.getElementById('transactions-table');
    if (!table) return;

    let csv = [];
    const rows = table.querySelectorAll('tr');

    for (let i = 0; i < rows.length; i++) {
      const row = rows[i];
      const cols = row.querySelectorAll('td, th');
      const csvRow = [];

      for (let j = 0; j < cols.length; j++) {
        let data = cols[j].innerText.replace(/(\r\n|\n|\r)/gm, '').trim();
        data = data.replace(/"/g, '""');
        csvRow.push('"' + data + '"');
      }

      csv.push(csvRow.join(','));
    }

    const csvString = csv.join('\n');
    const blob = new Blob([csvString], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.setAttribute('hidden', '');
    a.setAttribute('href', url);
    a.setAttribute('download', `payroll-transactions-${new Date().toISOString().split('T')[0]}.csv`);
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
  }
</script>
