---
import MainLayout from '../../../layouts/MainLayout.astro';
import { budgetService } from '../../../lib/services/budget.service';

const user = Astro.locals.user;

if (!user) {
  return Astro.redirect('/login');
}

const { id } = Astro.params;

if (!id || isNaN(parseInt(id))) {
  return Astro.redirect('/budget/obligations');
}

// Get obligation details
const obligations = await budgetService.getObligations();
const obligation = obligations.find(o => o.id === parseInt(id));

if (!obligation) {
  return Astro.redirect('/budget/obligations');
}

// Get budget availability for the allotment
const budgetAvailability = await budgetService.getBudgetAvailability(obligation.allotmentId);

// Format dates
const formatDate = (date: Date | string | null) => {
  if (!date) return 'N/A';
  const d = typeof date === 'string' ? new Date(date) : date;
  return d.toLocaleDateString('en-PH', { year: 'numeric', month: 'long', day: 'numeric' });
};

// Status badge classes
const getStatusBadge = (status: string) => {
  switch (status) {
    case 'pending':
      return 'badge-warning';
    case 'approved':
      return 'badge-success';
    case 'rejected':
      return 'badge-danger';
    default:
      return 'badge-secondary';
  }
};
---

<MainLayout title={`Obligation #${id}`}>
  <div class="container-fluid py-6">
    <!-- Page Header -->
    <div class="page-header">
      <div class="flex items-center gap-4 mb-2">
        <a href="/budget/obligations" class="text-gray-600 hover:text-gray-900">
          <i class="pi pi-arrow-left"></i>
        </a>
        <h1 class="page-title">Obligation Details</h1>
      </div>
      <div class="flex items-center justify-between">
        <p class="page-description">View obligation information and approval status</p>
        <span class={`badge ${getStatusBadge(obligation.status || 'pending')}`}>
          {obligation.status?.toUpperCase() || 'PENDING'}
        </span>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Main Information -->
      <div class="lg:col-span-2 space-y-6">
        <!-- Obligation Information -->
        <div class="card">
          <div class="card-header">
            <h3 class="text-lg font-semibold text-gray-900">Obligation Information</h3>
          </div>
          <div class="card-body">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label class="block text-sm font-medium text-gray-500 mb-1">ORS Number</label>
                <p class="text-base font-semibold text-gray-900">{obligation.orsNumber || 'N/A'}</p>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-500 mb-1">BURS Number</label>
                <p class="text-base font-semibold text-gray-900">{obligation.bursNumber || 'N/A'}</p>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-500 mb-1">Payee</label>
                <p class="text-base font-semibold text-gray-900">{obligation.payee}</p>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-500 mb-1">Amount</label>
                <p class="text-2xl font-bold text-primary-600">
                  ₱{parseFloat(obligation.amount.toString()).toLocaleString('en-PH', { minimumFractionDigits: 2 })}
                </p>
              </div>

              <div class="md:col-span-2">
                <label class="block text-sm font-medium text-gray-500 mb-1">Particulars</label>
                <p class="text-base text-gray-900">{obligation.particulars}</p>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-500 mb-1">Obligation Date</label>
                <p class="text-base text-gray-900">{formatDate(obligation.obligationDate)}</p>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-500 mb-1">Status</label>
                <span class={`badge ${getStatusBadge(obligation.status || 'pending')}`}>
                  {obligation.status?.toUpperCase() || 'PENDING'}
                </span>
              </div>

              {obligation.remarks && (
                <div class="md:col-span-2">
                  <label class="block text-sm font-medium text-gray-500 mb-1">Remarks</label>
                  <p class="text-base text-gray-900">{obligation.remarks}</p>
                </div>
              )}
            </div>
          </div>
        </div>

        <!-- Allotment Information -->
        <div class="card">
          <div class="card-header">
            <h3 class="text-lg font-semibold text-gray-900">Allotment Information</h3>
          </div>
          <div class="card-body">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label class="block text-sm font-medium text-gray-500 mb-1">Fund Cluster</label>
                <p class="text-base font-semibold text-gray-900">
                  {obligation.allotment.appropriation.fundCluster.code} - {obligation.allotment.appropriation.fundCluster.name}
                </p>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-500 mb-1">Allotment Class</label>
                <p class="text-base text-gray-900">{obligation.allotment.allotmentClass}</p>
              </div>

              <div class="md:col-span-2">
                <label class="block text-sm font-medium text-gray-500 mb-1">Object of Expenditure</label>
                <p class="text-base text-gray-900">
                  {obligation.allotment.objectOfExpenditure.code} - {obligation.allotment.objectOfExpenditure.name}
                </p>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-500 mb-1">Appropriation Reference</label>
                <p class="text-base text-gray-900">{obligation.allotment.appropriation.reference}</p>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-500 mb-1">Fiscal Year</label>
                <p class="text-base text-gray-900">{obligation.allotment.appropriation.year}</p>
              </div>

              <div class="md:col-span-2">
                <label class="block text-sm font-medium text-gray-500 mb-1">Purpose</label>
                <p class="text-base text-gray-900">{obligation.allotment.purpose}</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Sidebar -->
      <div class="space-y-6">
        <!-- Budget Availability -->
        <div class="card">
          <div class="card-header">
            <h3 class="text-lg font-semibold text-gray-900">Budget Availability</h3>
          </div>
          <div class="card-body">
            <div class="space-y-4">
              <div class="flex items-center justify-between pb-3 border-b border-gray-200">
                <span class="text-sm text-gray-600">Allotment</span>
                <span class="text-base font-semibold text-gray-900">
                  ₱{budgetAvailability.allotment.toLocaleString('en-PH', { minimumFractionDigits: 2 })}
                </span>
              </div>

              <div class="flex items-center justify-between pb-3 border-b border-gray-200">
                <span class="text-sm text-gray-600">Total Obligations</span>
                <span class="text-base font-semibold text-gray-900">
                  ₱{budgetAvailability.obligation.toLocaleString('en-PH', { minimumFractionDigits: 2 })}
                </span>
              </div>

              <div class="flex items-center justify-between">
                <span class="text-sm font-medium text-gray-900">Unobligated Balance</span>
                <span class="text-lg font-bold text-green-600">
                  ₱{budgetAvailability.unobligatedBalance.toLocaleString('en-PH', { minimumFractionDigits: 2 })}
                </span>
              </div>
            </div>

            <div class="mt-6">
              <div class="flex items-center justify-between text-sm text-gray-600 mb-2">
                <span>Utilization Rate</span>
                <span>{((budgetAvailability.obligation / budgetAvailability.allotment) * 100).toFixed(2)}%</span>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-3">
                <div
                  class="bg-primary-600 h-3 rounded-full transition-all"
                  style={`width: ${Math.min((budgetAvailability.obligation / budgetAvailability.allotment) * 100, 100)}%`}
                ></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Approval Information -->
        {obligation.status === 'approved' && obligation.approvedAt && (
          <div class="card">
            <div class="card-header">
              <h3 class="text-lg font-semibold text-gray-900">Approval Information</h3>
            </div>
            <div class="card-body">
              <div class="space-y-3">
                <div>
                  <label class="block text-sm font-medium text-gray-500 mb-1">Approved Date</label>
                  <p class="text-base text-gray-900">{formatDate(obligation.approvedAt)}</p>
                </div>
              </div>
            </div>
          </div>
        )}

        <!-- Actions -->
        {obligation.status === 'pending' && (
          <div class="card">
            <div class="card-header">
              <h3 class="text-lg font-semibold text-gray-900">Actions</h3>
            </div>
            <div class="card-body">
              <div class="space-y-3">
                <button
                  type="button"
                  class="btn btn-success btn-md w-full"
                  id="approve-btn"
                >
                  <i class="pi pi-check mr-2"></i>
                  Approve Obligation
                </button>
                <button
                  type="button"
                  class="btn btn-danger btn-md w-full"
                  id="reject-btn"
                >
                  <i class="pi pi-times mr-2"></i>
                  Reject Obligation
                </button>
              </div>
            </div>
          </div>
        )}

        <!-- Timestamps -->
        <div class="card">
          <div class="card-header">
            <h3 class="text-lg font-semibold text-gray-900">Record Information</h3>
          </div>
          <div class="card-body">
            <div class="space-y-3">
              <div>
                <label class="block text-sm font-medium text-gray-500 mb-1">Created At</label>
                <p class="text-sm text-gray-900">{formatDate(obligation.createdAt)}</p>
              </div>
              {obligation.updatedAt && (
                <div>
                  <label class="block text-sm font-medium text-gray-500 mb-1">Updated At</label>
                  <p class="text-sm text-gray-900">{formatDate(obligation.updatedAt)}</p>
                </div>
              )}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script define:vars={{ obligationId: parseInt(id) }}>
    const approveBtn = document.getElementById('approve-btn');
    const rejectBtn = document.getElementById('reject-btn');

    // Approve obligation
    approveBtn?.addEventListener('click', async () => {
      if (!confirm('Are you sure you want to approve this obligation?')) {
        return;
      }

      approveBtn.disabled = true;
      approveBtn.innerHTML = '<i class="pi pi-spin pi-spinner mr-2"></i> Approving...';

      try {
        const response = await fetch(`/api/budget/obligations/${obligationId}/approve`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        if (response.ok) {
          window.location.reload();
        } else {
          const error = await response.json();
          alert('Error: ' + (error.message || 'Failed to approve obligation'));
          approveBtn.disabled = false;
          approveBtn.innerHTML = '<i class="pi pi-check mr-2"></i> Approve Obligation';
        }
      } catch (error) {
        console.error('Error:', error);
        alert('An error occurred. Please try again.');
        approveBtn.disabled = false;
        approveBtn.innerHTML = '<i class="pi pi-check mr-2"></i> Approve Obligation';
      }
    });

    // Reject obligation
    rejectBtn?.addEventListener('click', async () => {
      const remarks = prompt('Please enter reason for rejection:');
      if (!remarks) {
        return;
      }

      rejectBtn.disabled = true;
      rejectBtn.innerHTML = '<i class="pi pi-spin pi-spinner mr-2"></i> Rejecting...';

      try {
        const response = await fetch(`/api/budget/obligations/${obligationId}/reject`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ remarks })
        });

        if (response.ok) {
          window.location.reload();
        } else {
          const error = await response.json();
          alert('Error: ' + (error.message || 'Failed to reject obligation'));
          rejectBtn.disabled = false;
          rejectBtn.innerHTML = '<i class="pi pi-times mr-2"></i> Reject Obligation';
        }
      } catch (error) {
        console.error('Error:', error);
        alert('An error occurred. Please try again.');
        rejectBtn.disabled = false;
        rejectBtn.innerHTML = '<i class="pi pi-times mr-2"></i> Reject Obligation';
      }
    });
  </script>
</MainLayout>
