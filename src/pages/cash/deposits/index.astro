---
import MainLayout from '../../../layouts/MainLayout.astro';
import { cashService } from '../../../lib/services/cash.service';
import { db } from '../../../lib/db/connection';
import { bankAccounts } from '../../../lib/db/schema';

const user = Astro.locals.user;

if (!user) {
  return Astro.redirect('/login');
}

// Get filter parameters from URL
const url = new URL(Astro.request.url);
const status = url.searchParams.get('status');
const bankAccountId = url.searchParams.get('bankAccountId');
const startDate = url.searchParams.get('startDate');
const endDate = url.searchParams.get('endDate');

// Fetch deposits with filters
const deposits = await cashService.getBankDeposits({
  status: status || undefined,
  bankAccountId: bankAccountId ? parseInt(bankAccountId) : undefined,
  startDate: startDate || undefined,
  endDate: endDate || undefined,
});

// Get bank accounts for filter dropdown
const allBankAccounts = await db.select().from(bankAccounts);

const formatCurrency = (amount: number | string) => {
  return new Intl.NumberFormat('en-PH', {
    style: 'currency',
    currency: 'PHP',
    minimumFractionDigits: 2,
  }).format(Number(amount));
};
---

<MainLayout title="Bank Deposits">
  <div class="container-fluid py-6">
    <!-- Page Header -->
    <div class="page-header">
      <div>
        <h1 class="page-title">Bank Deposits</h1>
        <p class="page-description">View and manage bank deposits</p>
      </div>
      <div class="flex gap-2">
        <a href="/cash" class="btn btn-ghost">
          <i class="pi pi-arrow-left mr-2"></i>
          Back to Cash Management
        </a>
        <a href="/cash/deposits/create" class="btn btn-primary">
          <i class="pi pi-plus mr-2"></i>
          Create Bank Deposit
        </a>
      </div>
    </div>

    <!-- Filters -->
    <div class="card mb-6">
      <div class="card-header">
        <h3 class="text-lg font-semibold">Filters</h3>
      </div>
      <div class="card-body">
        <form method="get" class="grid grid-cols-1 md:grid-cols-4 gap-4">
          <!-- Status -->
          <div>
            <label class="label">
              <span class="label-text">Status</span>
            </label>
            <select name="status" class="select select-bordered w-full">
              <option value="">All Statuses</option>
              <option value="pending" selected={status === 'pending'}>Pending</option>
              <option value="confirmed" selected={status === 'confirmed'}>Confirmed</option>
              <option value="cancelled" selected={status === 'cancelled'}>Cancelled</option>
            </select>
          </div>

          <!-- Bank Account -->
          <div>
            <label class="label">
              <span class="label-text">Bank Account</span>
            </label>
            <select name="bankAccountId" class="select select-bordered w-full">
              <option value="">All Bank Accounts</option>
              {allBankAccounts.map((account) => (
                <option value={account.id} selected={bankAccountId === account.id.toString()}>
                  {account.bankName} - {account.accountNumber}
                </option>
              ))}
            </select>
          </div>

          <!-- Date Range -->
          <div>
            <label class="label">
              <span class="label-text">Start Date</span>
            </label>
            <input
              type="date"
              name="startDate"
              value={startDate || ''}
              class="input input-bordered w-full"
            />
          </div>

          <div>
            <label class="label">
              <span class="label-text">End Date</span>
            </label>
            <input
              type="date"
              name="endDate"
              value={endDate || ''}
              class="input input-bordered w-full"
            />
          </div>

          <!-- Action Buttons -->
          <div class="md:col-span-4 flex gap-2">
            <button type="submit" class="btn btn-primary">
              <i class="pi pi-search mr-2"></i>
              Apply Filters
            </button>
            <a href="/cash/deposits" class="btn btn-ghost">
              <i class="pi pi-refresh mr-2"></i>
              Clear Filters
            </a>
          </div>
        </form>
      </div>
    </div>

    <!-- Deposits Table -->
    <div class="card">
      <div class="card-header">
        <div class="flex justify-between items-center">
          <h3 class="text-lg font-semibold">
            Bank Deposits ({deposits.length} {deposits.length === 1 ? 'deposit' : 'deposits'})
          </h3>
        </div>
      </div>
      <div class="card-body p-0">
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Deposit Slip No.</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Bank Account</th>
                <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Amount</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Deposited By</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Actions</th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              {deposits.length === 0 ? (
                <tr>
                  <td colspan="7" class="px-4 py-8 text-center text-gray-500">
                    <i class="pi pi-inbox text-4xl mb-2"></i>
                    <p>No deposits found matching the filters</p>
                  </td>
                </tr>
              ) : (
                deposits.map((deposit) => (
                  <tr class="hover:bg-gray-50">
                    <td class="px-4 py-3">
                      <span class="font-mono text-sm font-medium text-blue-600">
                        {deposit.depositSlipNo}
                      </span>
                    </td>
                    <td class="px-4 py-3">
                      <span class="text-sm text-gray-900">
                        {new Date(deposit.depositDate).toLocaleDateString('en-PH', {
                          year: 'numeric',
                          month: 'short',
                          day: 'numeric',
                        })}
                      </span>
                    </td>
                    <td class="px-4 py-3">
                      <div class="text-sm">
                        <div class="font-medium text-gray-900">{deposit.bankAccount?.bankName || 'N/A'}</div>
                        <div class="text-gray-500">{deposit.bankAccount?.accountNumber || ''}</div>
                      </div>
                    </td>
                    <td class="px-4 py-3 text-right">
                      <span class="text-sm font-semibold text-gray-900">
                        {formatCurrency(deposit.totalAmount)}
                      </span>
                    </td>
                    <td class="px-4 py-3">
                      <span class="text-sm text-gray-700">{deposit.depositedBy}</span>
                    </td>
                    <td class="px-4 py-3">
                      <span class={`badge badge-sm ${
                        deposit.status === 'pending' ? 'badge-warning' :
                        deposit.status === 'confirmed' ? 'badge-success' :
                        'badge-error'
                      }`}>
                        {deposit.status}
                      </span>
                    </td>
                    <td class="px-4 py-3 text-center">
                      <div class="flex gap-1 justify-center">
                        {deposit.status === 'pending' && (
                          <button
                            class="btn btn-xs btn-success"
                            onclick={`confirmDeposit(${deposit.id})`}
                            title="Confirm Deposit"
                          >
                            <i class="pi pi-check"></i>
                          </button>
                        )}
                      </div>
                    </td>
                  </tr>
                ))
              )}
            </tbody>
            {deposits.length > 0 && (
              <tfoot class="bg-gray-50">
                <tr>
                  <td colspan="3" class="px-4 py-3 text-right font-semibold">Total:</td>
                  <td class="px-4 py-3 text-right font-bold text-blue-600">
                    {formatCurrency(deposits.reduce((sum, d) => sum + Number(d.totalAmount), 0))}
                  </td>
                  <td colspan="3"></td>
                </tr>
              </tfoot>
            )}
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    async function confirmDeposit(id: number) {
      if (!confirm('Are you sure you want to confirm this deposit?')) {
        return;
      }

      try {
        const response = await fetch(`/api/cash/deposits/${id}/confirm`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'Failed to confirm deposit');
        }

        alert('Deposit confirmed successfully!');
        window.location.reload();
      } catch (error) {
        console.error('Error confirming deposit:', error);
        alert(`Error: ${error instanceof Error ? error.message : 'Failed to confirm deposit'}`);
      }
    }

    // Make function globally available
    (window as any).confirmDeposit = confirmDeposit;
  </script>
</MainLayout>
