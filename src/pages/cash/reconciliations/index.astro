---
import MainLayout from '../../../layouts/MainLayout.astro';
import { cashService } from '../../../lib/services/cash.service';
import { db } from '../../../lib/db/connection';
import { bankAccounts } from '../../../lib/db/schema';

const user = Astro.locals.user;

if (!user) {
  return Astro.redirect('/login');
}

// Get filter parameters from URL
const url = new URL(Astro.request.url);
const bankAccountId = url.searchParams.get('bankAccountId');
const month = url.searchParams.get('month');
const year = url.searchParams.get('year');

// Fetch reconciliations with filters
const reconciliations = await cashService.getBankReconciliations({
  bankAccountId: bankAccountId ? parseInt(bankAccountId) : undefined,
  month: month ? parseInt(month) : undefined,
  year: year ? parseInt(year) : undefined,
});

// Get bank accounts for filter dropdown
const allBankAccounts = await db.select().from(bankAccounts);

const formatCurrency = (amount: number | string) => {
  return new Intl.NumberFormat('en-PH', {
    style: 'currency',
    currency: 'PHP',
    minimumFractionDigits: 2,
  }).format(Number(amount));
};

const currentYear = new Date().getFullYear();
const years = Array.from({ length: 5 }, (_, i) => currentYear - i);

const months = [
  { value: 1, label: 'January' },
  { value: 2, label: 'February' },
  { value: 3, label: 'March' },
  { value: 4, label: 'April' },
  { value: 5, label: 'May' },
  { value: 6, label: 'June' },
  { value: 7, label: 'July' },
  { value: 8, label: 'August' },
  { value: 9, label: 'September' },
  { value: 10, label: 'October' },
  { value: 11, label: 'November' },
  { value: 12, label: 'December' },
];
---

<MainLayout title="Bank Reconciliations">
  <div class="container-fluid py-6">
    <!-- Page Header -->
    <div class="page-header">
      <div>
        <h1 class="page-title">Bank Reconciliations</h1>
        <p class="page-description">View and manage monthly bank reconciliations</p>
      </div>
      <div class="flex gap-2">
        <a href="/cash" class="btn btn-ghost">
          <i class="pi pi-arrow-left mr-2"></i>
          Back to Cash Management
        </a>
        <a href="/cash/reconciliations/create" class="btn btn-primary">
          <i class="pi pi-plus mr-2"></i>
          Create Reconciliation
        </a>
      </div>
    </div>

    <!-- Filters -->
    <div class="card mb-6">
      <div class="card-header">
        <h3 class="text-lg font-semibold">Filters</h3>
      </div>
      <div class="card-body">
        <form method="get" class="grid grid-cols-1 md:grid-cols-4 gap-4">
          <!-- Bank Account -->
          <div>
            <label class="label">
              <span class="label-text">Bank Account</span>
            </label>
            <select name="bankAccountId" class="select select-bordered w-full">
              <option value="">All Bank Accounts</option>
              {allBankAccounts.map((account) => (
                <option value={account.id} selected={bankAccountId === account.id.toString()}>
                  {account.bankName} - {account.accountNumber}
                </option>
              ))}
            </select>
          </div>

          <!-- Month -->
          <div>
            <label class="label">
              <span class="label-text">Month</span>
            </label>
            <select name="month" class="select select-bordered w-full">
              <option value="">All Months</option>
              {months.map((m) => (
                <option value={m.value} selected={month === m.value.toString()}>
                  {m.label}
                </option>
              ))}
            </select>
          </div>

          <!-- Year -->
          <div>
            <label class="label">
              <span class="label-text">Year</span>
            </label>
            <select name="year" class="select select-bordered w-full">
              <option value="">All Years</option>
              {years.map((y) => (
                <option value={y} selected={year === y.toString()}>
                  {y}
                </option>
              ))}
            </select>
          </div>

          <!-- Action Buttons -->
          <div class="flex items-end gap-2">
            <button type="submit" class="btn btn-primary">
              <i class="pi pi-search mr-2"></i>
              Apply Filters
            </button>
            <a href="/cash/reconciliations" class="btn btn-ghost">
              <i class="pi pi-refresh mr-2"></i>
              Clear
            </a>
          </div>
        </form>
      </div>
    </div>

    <!-- Reconciliations Table -->
    <div class="card">
      <div class="card-header">
        <div class="flex justify-between items-center">
          <h3 class="text-lg font-semibold">
            Bank Reconciliations ({reconciliations.length} {reconciliations.length === 1 ? 'reconciliation' : 'reconciliations'})
          </h3>
        </div>
      </div>
      <div class="card-body p-0">
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Period</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Bank Account</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Reconciliation Date</th>
                <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Book Balance</th>
                <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Bank Balance</th>
                <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Variance</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Actions</th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              {reconciliations.length === 0 ? (
                <tr>
                  <td colspan="8" class="px-4 py-8 text-center text-gray-500">
                    <i class="pi pi-inbox text-4xl mb-2"></i>
                    <p>No reconciliations found matching the filters</p>
                  </td>
                </tr>
              ) : (
                reconciliations.map((recon) => {
                  const bookBal = Number(recon.bookBalance);
                  const bankBal = Number(recon.bankBalance);
                  const variance = bookBal - bankBal;

                  return (
                    <tr class="hover:bg-gray-50">
                      <td class="px-4 py-3">
                        <span class="font-semibold">
                          {months.find(m => m.value === recon.periodMonth)?.label} {recon.periodYear}
                        </span>
                      </td>
                      <td class="px-4 py-3">
                        <div class="text-sm">
                          <div class="font-medium text-gray-900">{recon.bankAccount?.bankName || 'N/A'}</div>
                          <div class="text-gray-500">{recon.bankAccount?.accountNumber || ''}</div>
                        </div>
                      </td>
                      <td class="px-4 py-3">
                        <span class="text-sm text-gray-900">
                          {new Date(recon.reconciliationDate).toLocaleDateString('en-PH', {
                            year: 'numeric',
                            month: 'short',
                            day: 'numeric',
                          })}
                        </span>
                      </td>
                      <td class="px-4 py-3 text-right">
                        <span class="text-sm font-semibold text-gray-900">
                          {formatCurrency(bookBal)}
                        </span>
                      </td>
                      <td class="px-4 py-3 text-right">
                        <span class="text-sm font-semibold text-gray-900">
                          {formatCurrency(bankBal)}
                        </span>
                      </td>
                      <td class="px-4 py-3 text-right">
                        <span class={`text-sm font-bold ${
                          variance === 0 ? 'text-green-600' : 'text-red-600'
                        }`}>
                          {formatCurrency(Math.abs(variance))}
                          {variance !== 0 && (
                            <span class="text-xs ml-1">
                              {variance > 0 ? '(+)' : '(-)'}
                            </span>
                          )}
                        </span>
                      </td>
                      <td class="px-4 py-3">
                        <span class={`badge badge-sm ${
                          recon.status === 'pending' ? 'badge-warning' :
                          recon.status === 'completed' ? 'badge-success' :
                          'badge-error'
                        }`}>
                          {recon.status}
                        </span>
                      </td>
                      <td class="px-4 py-3 text-center">
                        <div class="flex gap-1 justify-center">
                          {recon.status === 'pending' && (
                            <button
                              class="btn btn-xs btn-success"
                              onclick={`completeReconciliation(${recon.id})`}
                              title="Complete Reconciliation"
                            >
                              <i class="pi pi-check"></i>
                            </button>
                          )}
                          <a
                            href={`/cash/reconciliations/${recon.id}`}
                            class="btn btn-xs btn-ghost"
                            title="View Details"
                          >
                            <i class="pi pi-eye"></i>
                          </a>
                        </div>
                      </td>
                    </tr>
                  );
                })
              )}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    async function completeReconciliation(id: number) {
      if (!confirm('Are you sure you want to mark this reconciliation as completed? This action cannot be undone.')) {
        return;
      }

      try {
        const response = await fetch(`/api/cash/reconciliations/${id}/complete`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'Failed to complete reconciliation');
        }

        alert('Reconciliation marked as completed successfully!');
        window.location.reload();
      } catch (error) {
        console.error('Error completing reconciliation:', error);
        alert(`Error: ${error instanceof Error ? error.message : 'Failed to complete reconciliation'}`);
      }
    }

    // Make function globally available
    (window as any).completeReconciliation = completeReconciliation;
  </script>
</MainLayout>
