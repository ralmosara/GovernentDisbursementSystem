---
import MainLayout from '../../../layouts/MainLayout.astro';
import BankReconciliationForm from '../../../components/forms/cash/BankReconciliationForm.vue';
import { db } from '../../../lib/db/connection';
import { bankAccounts } from '../../../lib/db/schema';

const user = Astro.locals.user;

if (!user) {
  return Astro.redirect('/login');
}

// Fetch bank accounts
const allBankAccounts = await db.select().from(bankAccounts);
---

<MainLayout title="Create Bank Reconciliation">
  <div class="container mx-auto px-4 py-6 max-w-6xl">
    <!-- Page Header -->
    <div class="mb-6">
      <a href="/cash/reconciliations" class="text-blue-600 hover:text-blue-700 inline-flex items-center gap-1 mb-2">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
        </svg>
        Back to Bank Reconciliations
      </a>
      <h1 class="text-3xl font-bold text-gray-900">Create Bank Reconciliation</h1>
      <p class="text-gray-600 mt-1">Reconcile book balance with bank statement balance</p>
    </div>

    <!-- Form Card -->
    <div class="card">
      <div class="card-header">
        <h2 class="text-lg font-semibold text-gray-900">Reconciliation Information</h2>
      </div>
      <div class="card-body">
        <BankReconciliationForm
          client:load
          bankAccounts={JSON.stringify(allBankAccounts)}
        />
      </div>
    </div>

    <!-- Help Text -->
    <div class="mt-6 bg-blue-50 border border-blue-200 rounded-lg p-4">
      <div class="flex gap-3">
        <i class="pi pi-info-circle text-blue-600 text-xl"></i>
        <div>
          <h3 class="font-semibold text-blue-900 mb-1">Bank Reconciliation Process:</h3>
          <ul class="text-sm text-blue-800 space-y-1">
            <li>• <strong>Book Balance:</strong> The cash balance according to your accounting system</li>
            <li>• <strong>Bank Balance:</strong> The balance shown on the bank statement</li>
            <li>• <strong>Outstanding Checks:</strong> Checks issued but not yet cleared by the bank</li>
            <li>• <strong>Deposits in Transit:</strong> Deposits made but not yet reflected in bank statement</li>
            <li>• <strong>Bank Charges:</strong> Service fees charged by the bank</li>
            <li>• <strong>Bank Interest:</strong> Interest earned on the account</li>
            <li>• The adjusted balances should match. If not, investigate the variance.</li>
          </ul>
        </div>
      </div>
    </div>

    <!-- Example Card -->
    <div class="mt-6 bg-green-50 border border-green-200 rounded-lg p-4">
      <div class="flex gap-3">
        <i class="pi pi-lightbulb text-green-600 text-xl"></i>
        <div>
          <h3 class="font-semibold text-green-900 mb-2">Reconciliation Formula:</h3>
          <div class="grid grid-cols-2 gap-4 text-sm">
            <div>
              <p class="font-medium text-green-800 mb-1">Adjusted Book Balance:</p>
              <p class="text-green-700">Book Balance</p>
              <p class="text-green-700">+ Bank Interest</p>
              <p class="text-green-700">- Bank Charges</p>
            </div>
            <div>
              <p class="font-medium text-green-800 mb-1">Adjusted Bank Balance:</p>
              <p class="text-green-700">Bank Balance</p>
              <p class="text-green-700">+ Deposits in Transit</p>
              <p class="text-green-700">- Outstanding Checks</p>
            </div>
          </div>
          <p class="mt-3 text-green-800 font-semibold">
            Adjusted Book Balance = Adjusted Bank Balance (when reconciled)
          </p>
        </div>
      </div>
    </div>
  </div>
</MainLayout>
