---
import MainLayout from '../../../layouts/MainLayout.astro';
import CashReceiptForm from '../../../components/forms/cash/CashReceiptForm.vue';
import { db } from '../../../lib/db/connection';
import { officialReceiptSeries, revenueSources, fundClusters } from '../../../lib/db/schema';
import { eq } from 'drizzle-orm';

const user = Astro.locals.user;

if (!user) {
  return Astro.redirect('/login');
}

// Fetch active OR series
const orSeries = await db
  .select()
  .from(officialReceiptSeries)
  .where(eq(officialReceiptSeries.isActive, true));

// Fetch revenue sources
const allRevenueSources = await db.select().from(revenueSources);

// Fetch fund clusters
const allFundClusters = await db.select().from(fundClusters);
---

<MainLayout title="Issue Official Receipt">
  <div class="container mx-auto px-4 py-6 max-w-4xl">
    <!-- Page Header -->
    <div class="mb-6">
      <a href="/cash/receipts" class="text-blue-600 hover:text-blue-700 inline-flex items-center gap-1 mb-2">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
        </svg>
        Back to Cash Receipts
      </a>
      <h1 class="text-3xl font-bold text-gray-900">Issue Official Receipt</h1>
      <p class="text-gray-600 mt-1">Create a new cash receipt with OR number</p>
    </div>

    <!-- Form Card -->
    <div class="card">
      <div class="card-header">
        <h2 class="text-lg font-semibold text-gray-900">Receipt Information</h2>
      </div>
      <div class="card-body">
        <CashReceiptForm
          client:load
          orSeries={JSON.stringify(orSeries)}
          revenueSources={JSON.stringify(allRevenueSources)}
          fundClusters={JSON.stringify(allFundClusters)}
        />
      </div>
    </div>

    <!-- Help Text -->
    <div class="mt-6 bg-blue-50 border border-blue-200 rounded-lg p-4">
      <div class="flex gap-3">
        <i class="pi pi-info-circle text-blue-600 text-xl"></i>
        <div>
          <h3 class="font-semibold text-blue-900 mb-1">Important Notes:</h3>
          <ul class="text-sm text-blue-800 space-y-1">
            <li>• OR numbers are automatically generated from the selected series</li>
            <li>• Ensure the payment mode matches the actual payment received</li>
            <li>• For check payments, all check details are required</li>
            <li>• Select the appropriate fund cluster for proper accounting</li>
            <li>• Revenue source is optional but recommended for reporting</li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</MainLayout>
